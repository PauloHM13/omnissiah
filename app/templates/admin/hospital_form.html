<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>{{ 'Novo' if mode=='new' else 'Editar' }} Hospital</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:24px}
    .wrap{max-width:1000px;margin:0 auto}
    fieldset{border:1px solid #ccc;padding:16px;margin-bottom:18px;border-radius:6px}
    legend{font-weight:600;padding:0 6px}
    label{display:block;margin:6px 0 4px}
    input,select,textarea{width:100%;padding:8px;box-sizing:border-box}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .table{border-collapse:collapse;width:100%}
    .table th,.table td{border:1px solid #ddd;padding:8px}
    .table th{background:#f7f7f7;text-align:left}
    .msg{margin:8px 0}
    .ok{color:#2e7d32}.err{color:#b00020}
  </style>
</head>
<body>
<div class="wrap">
  <h1>{{ 'Novo' if mode=='new' else 'Editar' }} Hospital</h1>
  <p><a href="{{ url_for('admin_hospitals.list_hospitals') }}">Voltar</a></p>

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}<ul>{% for cat,msg in msgs %}<li class="{{ 'ok' if cat=='ok' else 'err' }}">{{ msg }}</li>{% endfor %}</ul>{% endif %}
  {% endwith %}
  {% if error %}<p class="err msg">{{ error }}</p>{% endif %}
  {% if msg %}<p class="ok msg">{{ msg }}</p>{% endif %}

  <form method="post">
    <fieldset>
      <legend>Identificação</legend>
      <div class="grid">
        <div><label>Razão social</label><input name="corporate_name" value="{{ hospital.corporate_name if hospital else '' }}" required></div>
        <div><label>Nome fantasia</label><input name="trade_name" value="{{ hospital.trade_name if hospital else '' }}"></div>
        <div><label>Apelido (uso interno)</label>
          <input name="nickname" value="{{ hospital.nickname if hospital else '' }}">
        </div>
        <div><label>CNPJ</label><input name="cnpj" value="{{ hospital.cnpj if hospital else '' }}"></div>
        <div><label>IE</label><input name="state_reg" value="{{ hospital.state_reg if hospital else '' }}"></div>
        <div><label>IM</label><input name="city_reg" value="{{ hospital.city_reg if hospital else '' }}"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Endereço</legend>
      <div class="grid">
        <div><label>CEP</label><input name="cep" value="{{ hospital.cep if hospital else '' }}"></div>
        <div><label>Número</label><input name="number" value="{{ hospital.number if hospital else '' }}"></div>
        <div style="grid-column:1/3"><label>Logradouro</label><input name="street" value="{{ hospital.street if hospital else '' }}"></div>
        <div><label>Complemento</label><input name="complement" value="{{ hospital.complement if hospital else '' }}"></div>
        <div><label>Bairro</label><input name="district" value="{{ hospital.district if hospital else '' }}"></div>
        <div><label>Cidade</label><input name="city" value="{{ hospital.city if hospital else '' }}"></div>
        <div><label>UF</label><input name="state" maxlength="2" value="{{ hospital.state if hospital else '' }}"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contatos</legend>
      <div class="grid">
        <div><label>Tel.</label><input name="phone" value="{{ hospital.phone if hospital else '' }}"></div>
        <div><label>E-mail</label><input name="email" value="{{ hospital.email if hospital else '' }}"></div>
        <div><label>Resp. Contrato (nome)</label><input name="contract_contact_name" value="{{ hospital.contract_contact_name if hospital else '' }}"></div>
        <div><label>Resp. Contrato (e-mail)</label><input name="contract_contact_email" value="{{ hospital.contract_contact_email if hospital else '' }}"></div>
        <div><label>Resp. Contrato (tel.)</label><input name="contract_contact_phone" value="{{ hospital.contract_contact_phone if hospital else '' }}"></div>
        <div><label>Resp. Faturamento (nome)</label><input name="billing_contact_name" value="{{ hospital.billing_contact_name if hospital else '' }}"></div>
        <div><label>Resp. Faturamento (e-mail)</label><input name="billing_contact_email" value="{{ hospital.billing_contact_email if hospital else '' }}"></div>
        <div><label>Resp. Faturamento (tel.)</label><input name="billing_contact_phone" value="{{ hospital.billing_contact_phone if hospital else '' }}"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Dados bancários</legend>
      <div class="grid">
        <div><label>Banco</label><input name="bank_name" value="{{ hospital.bank_name if hospital else '' }}"></div>
        <div><label>Agência</label><input name="bank_agency" value="{{ hospital.bank_agency if hospital else '' }}"></div>
        <div><label>Conta</label><input name="bank_account" value="{{ hospital.bank_account if hospital else '' }}"></div>
        <div><label>Tipo</label><input name="bank_type" value="{{ hospital.bank_type if hospital else '' }}"></div>
        <div><label>Favorecido</label><input name="bank_holder" value="{{ hospital.bank_holder if hospital else '' }}"></div>
        <div><label>Doc. Favorecido</label><input name="bank_holder_doc" value="{{ hospital.bank_holder_doc if hospital else '' }}"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Contrato & Faturamento</legend>
      <div class="grid">
        <div><label>Vigência início</label><input type="date" name="contract_start" value="{{ hospital.contract_start if hospital and hospital.contract_start else '' }}"></div>
        <div><label>Vigência fim</label><input type="date" name="contract_end" value="{{ hospital.contract_end if hospital and hospital.contract_end else '' }}"></div>
        <div><label>Prazo de pagamento</label><input name="pay_term" value="{{ hospital.pay_term if hospital else '' }}"></div>
        <div><label>Regra de reajuste</label><input name="reajuste_rule" value="{{ hospital.reajuste_rule if hospital else '' }}"></div>
        <div><label>Multa/Juros</label><input name="fine_interest" value="{{ hospital.fine_interest if hospital else '' }}"></div>
        <div><label>Canal de envio da fatura</label><input name="invoice_channel" value="{{ hospital.invoice_channel if hospital else '' }}"></div>
        <div><label>Prazo envio produção</label><input name="send_deadline" value="{{ hospital.send_deadline if hospital else '' }}"></div>
        <div><label>Tipo de Nota (NF-e/RPS)</label><input name="nf_type" value="{{ hospital.nf_type if hospital else '' }}"></div>
        <div><label>CFOP</label><input name="cfop" value="{{ hospital.cfop if hospital else '' }}"></div>
        <div><label>CNAE</label><input name="cnae" value="{{ hospital.cnae if hospital else '' }}"></div>
        <div><label>Cód. serviço municipal</label><input name="city_service_code" value="{{ hospital.city_service_code if hospital else '' }}"></div>
      </div>
      <label>Observações</label>
      <textarea name="notes">{{ hospital.notes if hospital else '' }}</textarea>
    </fieldset>

    <button type="submit">{{ 'Criar hospital' if mode=='new' else 'Salvar' }}</button>
  </form>

  {% if mode=='edit' %}
  <hr id="prices">
  <h2>Tabela de Preços</h2>

  <!-- Form simplificado: Procedimento, Preço e Observações -->
  <form method="post" action="{{ url_for('admin_hospitals.add_price', hospital_id=hospital.id) }}">
    <div class="grid">
      <div>
        <label>Procedimento</label>
        <select name="procedure_id" required>
          <option value="">-- selecione --</option>
          {% for p in procedures %}
            <option value="{{ p.id }}">{{ p.tuss_code }} — {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Preço (R$)</label>
        <input name="price" required>
      </div>
    </div>
    <label>Observações</label>
    <input name="note">
    <button type="submit" style="margin-top:8px">Adicionar preço</button>
  </form>

  <table class="table" style="margin-top:16px">
    <tr>
      <th>Procedimento</th>
      <th>Preço (R$)</th>
      <th>Observações</th>
      <th>Ativo</th>
      <th>Ações</th>
    </tr>
    {% for r in prices %}
      <tr>
        <td>{{ r.tuss_code }} — {{ r.name }}</td>
        <td>{{ '%.2f'|format(r.price) }}</td>
        <td>{{ r.note or '-' }}</td>
        <td>{{ 'Sim' if r.active else 'Não' }}</td>
        <td>
          <form method="post"
                action="{{ url_for('admin_hospitals.deactivate_price', hospital_id=hospital.id, price_id=r.id) }}"
                style="display:inline"
                onsubmit="return confirm('Inativar preço?')">
            <button type="submit">Inativar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </table>
  {% endif %}
</div>
</body>
</html>
