{% extends "base.html" %}
{% block title %}{{ 'Novo' if mode=='new' else 'Editar' }} Usuário · MedOptic{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h4 mb-0">{{ 'Novo' if mode=='new' else 'Editar' }} Usuário</h1>
  <a class="btn btn-outline-secondary" href="{{ url_for('admin_users.list_users') }}">Voltar</a>
</div>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}
{% if msg %}
  <div class="alert alert-success">{{ msg }}</div>
{% endif %}

<form method="post" class="needs-validation" novalidate>
  <!-- Dados de acesso -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Dados de acesso</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Papel</label>
          {% set r = (user.role if user else '') %}
          <select name="role" class="form-select" required id="role">
            <option value="">-- selecione --</option>
            <option value="admin"  {{ 'selected' if r=='admin'  else '' }}>Admin</option>
            <option value="doctor" {{ 'selected' if r=='doctor' else '' }}>Médico</option>
          </select>
          <div class="invalid-feedback">Selecione o papel.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Usuário (login)</label>
          <input name="username" class="form-control" value="{{ user.username if user else '' }}" required>
          <div class="invalid-feedback">Informe o usuário.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">E-mail</label>
          <input name="email" type="email" class="form-control" value="{{ user.email if user else '' }}" required>
          <div class="invalid-feedback">Informe um e-mail válido.</div>
        </div>

        {% if mode=='edit' %}
        <div class="col-md-4">
          <label class="form-label d-block">Status</label>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {{ 'checked' if user.is_active else '' }}>
            <label class="form-check-label" for="is_active">Ativo</label>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Contato -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Contato</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Telefone</label>
          <input name="phone" class="form-control" value="{{ user.phone or '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Endereço -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Endereço</h2>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">CEP</label>
          <input name="cep" class="form-control" value="{{ user.cep or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Número</label>
          <input name="number" class="form-control" value="{{ user.number or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Logradouro</label>
          <input name="street" class="form-control" value="{{ user.street or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Complemento</label>
          <input name="complement" class="form-control" value="{{ user.complement or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Bairro</label>
          <input name="district" class="form-control" value="{{ user.district or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Cidade</label>
          <input name="city" class="form-control" value="{{ user.city or '' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">UF</label>
          <input name="state" maxlength="2" class="form-control text-uppercase" value="{{ user.state or '' }}">
        </div>
      </div>
    </div>
  </div>

  <!-- Dados do Médico -->
  <div class="card shadow-sm mb-3" id="doctorBox" style="display:none;">
    <div class="card-body">
      <h2 class="h6 mb-3">Dados do Médico</h2>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nome completo</label>
          <input name="full_name" class="form-control" value="{{ (doc.full_name if doc else '') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">CRM</label>
          <input name="crm" class="form-control" value="{{ (doc.crm if doc else '') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">RQE</label>
          <input name="rqe" class="form-control" value="{{ (doc.rqe if doc else '') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">CPF</label>
          <input name="cpf" class="form-control" value="{{ (doc.cpf if doc else '') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">RG</label>
          <input name="rg" class="form-control" value="{{ (doc.rg if doc else '') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Especialidade</label>
          <input name="specialty" class="form-control" value="{{ (doc.specialty if doc else '') }}">
        </div>
      </div>

      <hr class="my-4">

      <!-- Dados da Empresa do Médico -->
      <h3 class="h6 mb-3">Empresa do Médico</h3>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">CNPJ</label>
          <input name="company_cnpj" class="form-control" placeholder="00.000.000/0000-00"
                 value="{{ (doc.company_cnpj if doc and doc.company_cnpj is defined else '') }}">
        </div>
        <div class="col-md-5">
          <label class="form-label">Razão social</label>
          <input name="company_name" class="form-control"
                 value="{{ (doc.company_name if doc and doc.company_name is defined else '') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">CRM da empresa</label>
          <input name="company_crm" class="form-control"
                 value="{{ (doc.company_crm if doc and doc.company_crm is defined else '') }}">
        </div>
      </div>

      <hr class="my-4">

      <h2 class="h6 mb-2">Hospitais de atuação</h2>
      <div class="row g-2">
        {% set selected_ids = doc_hospital_ids or [] %}
        {% for h in hospitals %}
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="hospital_ids" id="h{{ h.id }}" value="{{ h.id }}"
                     {% if h.id in selected_ids %}checked{% endif %}>
              <label class="form-check-label" for="h{{ h.id }}">
                {{ h.nickname or h.trade_name or h.corporate_name }}
              </label>
            </div>
          </div>
        {% endfor %}
        {% if not hospitals %}
          <div class="col-12"><div class="text-muted">Nenhum hospital cadastrado.</div></div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-primary">Salvar</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin_users.list_users') }}">Cancelar</a>
  </div>
</form>

<script>
(function(){
  const form = document.querySelector('.needs-validation');
  if(form){
    form.addEventListener('submit', function(e){
      if(!form.checkValidity()){
        e.preventDefault(); e.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  }

  const roleSel = document.getElementById('role');
  const box = document.getElementById('doctorBox');
  function toggleDoctorBox(){
    box.style.display = (roleSel.value === 'doctor') ? '' : 'none';
  }
  if(roleSel){
    toggleDoctorBox();
    roleSel.addEventListener('change', toggleDoctorBox);
  }
})();
</script>
{% endblock %}
