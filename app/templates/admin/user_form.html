<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>{{ 'Novo' if mode=='new' else 'Editar' }} Usuário</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:24px;}
    .wrap{max-width:960px;margin:0 auto;}
    fieldset{border:1px solid #ccc;padding:16px;margin-bottom:18px;border-radius:6px;}
    legend{font-weight:600;padding:0 6px;}
    label{display:block;margin:6px 0 4px;}
    input,select{width:100%;padding:8px;box-sizing:border-box;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
    .actions{display:flex;gap:12px;align-items:center;margin-top:8px}
    .danger{color:#b00020}.success{color:#2e7d32}
    .chk{display:flex;align-items:center;gap:8px;padding:6px 0}
  </style>
  <script>
    function toggleDoctorFields(val){
      var box=document.getElementById('doctorFields');
      if(box) box.style.display=(val==='doctor')?'block':'none';
    }
    document.addEventListener('DOMContentLoaded', function(){
      const roleSel=document.querySelector('select[name="role"]');
      if(roleSel){
        toggleDoctorFields(roleSel.value);
        roleSel.addEventListener('change', e=>toggleDoctorFields(e.target.value));
      }
    });
  </script>
</head>
<body>
<div class="wrap">
  <h1>{{ 'Novo' if mode=='new' else 'Editar' }} Usuário</h1>
  <p><a href="{{ url_for('admin_users.list_users') }}">Voltar</a></p>

  {% if error %}<p class="danger">{{ error }}</p>{% endif %}
  {% if msg %}<p class="success">{{ msg }}</p>{% endif %}

  <form method="post">
    <fieldset>
      <legend>Dados de acesso</legend>
      <div class="grid">
        <div>
          <label for="role">Papel</label>
          {% set r = (user.role if user else '') %}
          <select name="role" id="role" required>
            <option value="">-- selecione --</option>
            <option value="admin"  {{ 'selected' if r=='admin'  else '' }}>Admin</option>
            <option value="doctor" {{ 'selected' if r=='doctor' else '' }}>Médico</option>
          </select>
        </div>
        <div></div>
        <div>
          <label>Usuário (login)</label>
          <input name="username" value="{{ user.username if user else '' }}" required>
        </div>
        <div>
          <label>E-mail</label>
          <input name="email" type="email" value="{{ user.email if user else '' }}" required>
        </div>
        {% if mode=='edit' %}
        <div>
          <label>Status</label>
          <label><input type="checkbox" name="is_active" {{ 'checked' if user.is_active else '' }}> Ativo</label>
        </div>
        {% endif %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Contato</legend>
      <div class="grid">
        <div>
          <label>Telefone</label>
          <input name="phone" value="{{ user.phone or '' }}">
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Endereço</legend>
      <div class="grid">
        <div><label>CEP</label><input name="cep" value="{{ user.cep or '' }}"></div>
        <div><label>Número</label><input name="number" value="{{ user.number or '' }}"></div>
        <div style="grid-column:1/3"><label>Logradouro</label><input name="street" value="{{ user.street or '' }}"></div>
        <div><label>Complemento</label><input name="complement" value="{{ user.complement or '' }}"></div>
        <div><label>Bairro</label><input name="district" value="{{ user.district or '' }}"></div>
        <div><label>Cidade</label><input name="city" value="{{ user.city or '' }}"></div>
        <div><label>Estado (UF)</label><input name="state" maxlength="2" style="text-transform:uppercase" value="{{ user.state or '' }}"></div>
      </div>
    </fieldset>

    <div id="doctorFields" style="display:none">
      <fieldset>
        <legend>Dados do Médico</legend>
        <div class="grid">
          <div style="grid-column:1/2"><label>Nome completo</label><input name="full_name" value="{{ (doc.full_name if doc else '') }}"></div>
          <div><label>CRM</label><input name="crm" value="{{ (doc.crm if doc else '') }}"></div>
          <div><label>RQE</label><input name="rqe" value="{{ (doc.rqe if doc else '') }}"></div>
          <div><label>CPF</label><input name="cpf" value="{{ (doc.cpf if doc else '') }}"></div>
          <div><label>RG</label><input name="rg" value="{{ (doc.rg if doc else '') }}"></div>
          <div style="grid-column:1/3"><label>Especialidade</label><input name="specialty" value="{{ (doc.specialty if doc else '') }}"></div>
        </div>
      </fieldset>

      <!-- NOVO: Hospitais de atuação -->
      <fieldset>
        <legend>Hospitais de atuação</legend>
        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
          {% set selected_ids = doc_hospital_ids or [] %}
          {% for h in hospitals %}
            <label class="chk">
              <input type="checkbox" name="hospital_ids" value="{{ h.id }}"
                     {% if h.id in selected_ids %}checked{% endif %}>
              {{ h.nickname or h.trade_name or h.corporate_name }} (ID {{ h.id }})
            </label>
          {% endfor %}
        </div>
        <small>Selecione um ou mais hospitais onde este médico atua.</small>
      </fieldset>
    </div>

    <div class="actions">
      <button type="submit">{{ 'Criar usuário' if mode=='new' else 'Salvar' }}</button>
    </div>
  </form>
</div>
</body>
</html>
