{% extends "base_doctor.html" %}
{% block doctor_title %}Lançar Produção · MedOptic{% endblock %}

{% block doctor_content %}

<h1 class="h5 mb-3">Lançar Produção</h1>

{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
    {% for cat,msg in msgs %}
      <div class="alert {{ 'alert-success' if cat=='ok' else 'alert-danger' }} py-2">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- NOVO LANÇAMENTO -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post" action="{{ url_for('doctor_production.production_submit') }}">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <label class="form-label">Unidade (hospital)</label>
          <select class="form-select" name="hospital_id" required>
            <option value="">-- selecione --</option>
            {% for h in hospitals %}
              <option value="{{ h.id }}">
                {{ h.nickname or h.trade_name or h.corporate_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Data de execução</label>
          <input type="date" class="form-control" name="exec_date" required>
        </div>
      </div>

      <hr class="my-3">

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-2">
          <thead class="table-light">
            <tr>
              <th style="width:55%">Procedimento</th>
              <th class="text-end" style="width:12%">Quantidade</th>
              <th>Observação</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="d-flex gap-2">
        <button type="button" id="btnAdd" class="btn btn-outline-secondary btn-sm">+ Adicionar procedimento</button>
        <button class="btn btn-primary ms-auto">Salvar produção</button>
      </div>
    </form>
  </div>
</div>

<!-- HISTÓRICO / FILTROS -->
<h2 class="h6 mb-2">Minhas produções</h2>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form id="filterForm" class="row g-3 align-items-end" method="get"
          action="{{ url_for('doctor_production.production_form') }}">

      <div class="col-12 col-md-4">
        <label class="form-label">Unidade (hospital)</label>
        <select class="form-select" name="f_hospital_id" onchange="autoSubmitFilters()">
          <option value="">(todas)</option>
          {% for h in hospitals %}
            <option value="{{ h.id }}" {{ 'selected' if f_hospital_id==h.id else '' }}>
              {{ h.nickname or h.trade_name or h.corporate_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label">
          Procedimento
          {% if not f_hospital_id %}
            <span class="text-muted small">(Selecione um hospital para listar)</span>
          {% endif %}
        </label>
        <select class="form-select" name="f_procedure_id" {{ '' if f_hospital_id else 'disabled' }}>
          <option value="">(todos)</option>
          {% for p in filter_procedures %}
            <option value="{{ p.procedure_id }}" {{ 'selected' if f_procedure_id==p.procedure_id else '' }}>
              {{ p.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Data inicial</label>
        <input type="date" class="form-control" name="f_date_from" value="{{ f_date_from }}">
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Data final</label>
        <input type="date" class="form-control" name="f_date_to" value="{{ f_date_to }}">
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary">Filtrar</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('doctor_production.production_form') }}">Limpar</a>
      </div>
    </form>
  </div>
</div>

<!-- LISTA (SEM VALORES) -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="min-width:110px">Data</th>
            <th>Hospital</th>
            <th>Procedimento</th>
            <th class="text-end">Qtd</th>
            <th>Obs.</th>
            <th style="width:110px">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% if rows and rows|length %}
            {% for r in rows %}
              <tr>
                <td>{{ r.exec_date|br_date }}</td>
                <td>{{ r.hospital_name }}</td>
                <td>{{ r.procedure_name }}</td>
                <td class="text-end">{{ r.quantity }}</td>
                <td class="text-muted">{{ r.note or '' }}</td>
                <td>
                  <form method="post"
                        action="{{ url_for('doctor_production.delete_production', prod_id=r.id) }}"
                        onsubmit="return confirm('Remover este lançamento?');">
                    <!-- preserva filtros no retorno -->
                    <input type="hidden" name="f_hospital_id" value="{{ f_hospital_id or '' }}">
                    <input type="hidden" name="f_procedure_id" value="{{ f_procedure_id or '' }}">
                    <input type="hidden" name="f_date_from" value="{{ f_date_from or '' }}">
                    <input type="hidden" name="f_date_to" value="{{ f_date_to or '' }}">
                    <button class="btn btn-sm btn-outline-danger">Excluir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" class="text-muted">Nenhum lançamento encontrado para os filtros selecionados.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- JS -->
<script>
  const AJAX_URL = "{{ url_for('doctor_production.ajax_procedures_by_hospital') }}";

  async function loadProcedures(){
    const hidSel = document.querySelector('select[name="hospital_id"]');
    if (!hidSel) return;
    const hid = hidSel.value;
    if (!hid) return;

    try{
      const url = `${AJAX_URL}?hospital_id=${encodeURIComponent(hid)}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      const data = await res.json();
      if (!data.ok){ alert(data.error || "Erro ao carregar procedimentos"); return; }

      document.querySelectorAll('select[name="procedure_id"]').forEach(sel=>{
        const cur = sel.value;
        sel.innerHTML = `<option value="">-- selecione --</option>`;
        data.procedures.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.label; // label sem TUSS
          sel.appendChild(opt);
        });
        if (cur && Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur;
      });
    }catch(e){
      console.error(e);
      alert("Falha ao carregar procedimentos.");
    }
  }

  function addRow(){
    const tbody = document.getElementById('rows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select class="form-select form-select-sm" name="procedure_id" required>
          <option value="">-- selecione --</option>
        </select>
      </td>
      <td class="text-end">
        <input class="form-control form-control-sm text-end" name="quantity" type="number" min="1" step="1" value="1" required>
      </td>
      <td>
        <input class="form-control form-control-sm" name="note" placeholder="Observação (opcional)">
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="this.closest('tr').remove()">Remover</button>
      </td>
    `;
    tbody.appendChild(tr);
    loadProcedures();
  }

  function autoSubmitFilters(){
    const f = document.getElementById('filterForm');
    if (f) f.submit();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const selHospital = document.querySelector('select[name="hospital_id"]');
    if (selHospital) selHospital.addEventListener('change', loadProcedures);

    // primeira linha de procedimento
    addRow();
    loadProcedures();

    const btnAdd = document.getElementById('btnAdd');
    if (btnAdd) btnAdd.addEventListener('click', addRow);
  });
</script>

{% endblock %}
